<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asociar imagen a artículo</title>
  <style>
    body { 
      font-family: system-ui, sans-serif; 
      max-width: 600px; 
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .form-group { margin-bottom: 1.5rem; }
    label { 
      display: block; 
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #333;
    }
    input, button { 
      width: 100%; 
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #0056b3; }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .preview-container {
      position: relative;
      margin: 1rem 0;
      background: #f8f9fa;
      border-radius: 4px;
      overflow: hidden;
    }
    #preview {
      width: 100%;
      height: 200px;
      object-fit: contain;
      display: none;
    }
    .drag-over {
      border: 2px dashed #007bff;
      background: #e7f1ff;
    }
    .message {
      padding: 0.75rem;
      border-radius: 4px;
      margin: 1rem 0;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #fff3cd; color: #856404; }
    .spinner {
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>Asociar imagen a artículo</h1>

  <form id="formUpload" class="form-group">
    <div class="form-group">
      <label for="codigo">Código del artículo</label>
      <input 
        type="text" 
        id="codigo" 
        placeholder="Ejemplo: 15121502092075671" 
        pattern="\d{17}"
        required
      />
      <small class="hint">Debe contener exactamente 17 dígitos</small>
    </div>

    <div class="form-group">
      <label for="imagen">Seleccionar imagen</label>
      <div class="preview-container" id="dropZone">
        <input 
          type="file" 
          id="imagen" 
          accept="image/jpeg,image/png,image/webp" 
          required
        />
        <img id="preview" alt="Vista previa de la imagen seleccionada" />
        <div id="dropText" class="drop-text">Arrastra la imagen aquí o haz clic para seleccionar</div>
      </div>
    </div>

    <button type="submit" id="btnSubir" disabled>
      <span class="spinner">⏳</span>
      Subir imagen y asociar
    </button>
  </form>

  <div id="mensaje" role="alert"></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://qpccqoeronbcdyejfjod.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwY2Nxb2Vyb25iY2R5ZWpmam9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyMzA5MzIsImV4cCI6MjA1OTgwNjkzMn0.v_KA6VdHl-F3sRiVaFMsfDQCS1qKERFBk5mTBcSiIDQ'
    );

    const form = document.getElementById('formUpload');
    const mensaje = document.getElementById('mensaje');
    const preview = document.getElementById('preview');
    const dropZone = document.getElementById('dropZone');
    const btnSubir = document.getElementById('btnSubir');
    const spinner = document.querySelector('.spinner');

    // Validación inicial
    form.addEventListener('input', () => {
      btnSubir.disabled = !form.checkValidity();
    });

    // Drag and Drop
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });

    // Manejo de archivo
    document.getElementById('imagen').addEventListener('change', (e) => {
      handleFile(e.target.files[0]);
    });

    function handleFile(file) {
      if (!file) return;

      const tiposValidos = ['image/jpeg', 'image/png', 'image/webp'];
      if (!tiposValidos.includes(file.type)) {
        mostrarMensaje('❌ Formato no válido. Use JPG, PNG o WebP.', 'error');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        mostrarMensaje('❌ El tamaño máximo permitido es 5MB.', 'error');
        return;
      }

      mostrarPreview(file);
    }

    function mostrarPreview(file) {
      preview.style.display = 'block';
      const reader = new FileReader();
      reader.onload = (e) => preview.src = e.target.result;
      reader.readAsDataURL(file);
    }

    // Envío del formulario
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const codigo = document.getElementById('codigo').value.trim();
      const archivo = document.getElementById('imagen').files[0];
      
      if (!codigo || !archivo) return;

      btnSubir.disabled = true;
      spinner.style.display = 'inline-block';
      
      try {
        // Validar código antes de subir
        if (!/^\d{17}$/.test(codigo)) {
          throw new Error('El código debe tener 17 dígitos numéricos');
        }

        // Subir imagen
        const ext = archivo.name.split('.').pop();
        const nombreArchivo = `${codigo}_${Date.now()}.${ext}`;
        
        const { error: uploadError } = await supabase.storage
          .from('imagenes')
          .upload(nombreArchivo, archivo);

        if (uploadError) throw uploadError;

        // Obtener URL
        const { data: { publicUrl } } = supabase.storage
          .from('imagenes')
          .getPublicUrl(nombreArchivo);

        // Actualizar artículo
        const { error: updateError } = await supabase
          .from('articulo_01')
          .update({ imagen_url: publicUrl })
          .eq('codigo_articulo', codigo);

        if (updateError) throw updateError;

        mostrarMensaje(`✅ Imagen asociada correctamente. <a href="${publicUrl}" target="_blank">Ver imagen</a>`, 'success');
        form.reset();
        preview.style.display = 'none';
      } catch (error) {
        mostrarMensaje(`❌ Error: ${error.message}`, 'error');
      } finally {
        btnSubir.disabled = false;
        spinner.style.display = 'none';
      }
    });

    function mostrarMensaje(texto, tipo) {
      mensaje.className = `message ${tipo}`;
      mensaje.innerHTML = texto;
      mensaje.focus();
      
      if (tipo === 'success') {
        setTimeout(() => mensaje.textContent = '', 5000);
      }
    }
  </script>
</body>
</html>
