<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Portal de acceso al Sistema SDMO">
  <meta name="theme-color" content="#3498db">
  <title>Login - SDMO</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Configuración Supabase
    const supabaseUrl = 'https://qpccqoeronbcdyejfjod.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwY2Nxb2Vyb25iY2R5ZWpmam9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyMzA5MzIsImV4cCI6MjA1OTgwNjkzMn0.v_KA6VdHl-F3sRiVaFMsfDQCS1qKERFBk5mTBcSiIDQ';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Inicializador de la aplicación
    function initApp() {
      const loginForm = document.getElementById("loginForm");
      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");
      const submitBtn = document.getElementById("submitBtn");
      const errorElement = document.getElementById("errorMsg");
      const passwordToggle = document.getElementById("passwordToggle");
      
      // Verificar si hay un error en la URL (por ejemplo, después de un redireccionamiento)
      checkUrlParams();

      // Recordar email si está guardado
      restoreEmail();
      
      // Evento submit del formulario
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        await handleLogin();
      });

      // Mostrar/ocultar contraseña
      passwordToggle.addEventListener("click", () => {
        const type = passwordInput.type === 'password' ? 'text' : 'password';
        passwordInput.type = type;
        passwordToggle.innerHTML = type === 'password' ? 
          '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>' : 
          '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>';
      });

      // Eventos para limpiar errores cuando el usuario comienza a escribir
      emailInput.addEventListener("input", clearError);
      passwordInput.addEventListener("input", clearError);

      // Función para manejar el login
      async function handleLogin() {
        try {
          const email = emailInput.value.trim();
          const password = passwordInput.value;
          const rememberMe = document.getElementById("rememberMe").checked;

          // Validación básica
          if (!email || !password) {
            showError("Por favor complete todos los campos");
            return;
          }

          if (!isValidEmail(email)) {
            showError("Por favor ingrese un correo electrónico válido");
            return;
          }

          showLoading(true);
          clearError();

          // Guardar email si "recordarme" está marcado
          if (rememberMe) {
            localStorage.setItem('sdmo_email', email);
          } else {
            localStorage.removeItem('sdmo_email');
          }

          // Autenticación con Supabase
          const { data, error } = await supabase.auth.signInWithPassword({ 
            email, 
            password 
          });

          if (error) throw error;

          // Redirección a página principal
          window.location.href = "inicio.html";

        } catch (error) {
          console.error("Error de autenticación:", error);
          
          if (error.message.includes("Email not confirmed")) {
            showError("Correo electrónico no verificado. Por favor revise su bandeja de entrada.");
          } else if (error.message.includes("Invalid login credentials")) {
            showError("Credenciales inválidas. Verifique su correo y contraseña.");
          } else {
            showError("Error al iniciar sesión. Intente nuevamente más tarde.");
          }
        } finally {
          showLoading(false);
        }
      }

      // Mostrar mensaje de error
      function showError(message) {
        errorElement.textContent = message;
        errorElement.style.display = "block";
        // Agrega clase para animación
        errorElement.classList.add("error-shake");
        // Quita la clase después de que termine la animación
        setTimeout(() => {
          errorElement.classList.remove("error-shake");
        }, 500);
      }

      // Limpiar mensaje de error
      function clearError() {
        errorElement.textContent = "";
        errorElement.style.display = "none";
      }

      // Mostrar/ocultar loading
      function showLoading(show) {
        if (show) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = 'Iniciando sesión <span class="loader"></span>';
        } else {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Iniciar Sesión';
        }
      }
      
      // Validar formato de email
      function isValidEmail(email) {
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailPattern.test(email);
      }
      
      // Restaurar email si existe en localStorage
      function restoreEmail() {
        const savedEmail = localStorage.getItem('sdmo_email');
        if (savedEmail) {
          emailInput.value = savedEmail;
          document.getElementById("rememberMe").checked = true;
        }
      }
      
      // Verificar si hay parámetros de error en la URL
      function checkUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const errorMsg = urlParams.get('error');
        
        if (errorMsg) {
          showError(decodeURIComponent(errorMsg));
        }
      }
    }

    // Iniciar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
  <style>
    :root {
      --primary-color: #3498db;
      --primary-dark: #2980b9;
      --text-color: #2c3e50;
      --error-color: #e74c3c;
      --background-color: #f4f6f8;
      --card-background: #ffffff;
      --border-color: #ddd;
      --shadow-color: rgba(0,0,0,0.08);
      --focus-shadow: rgba(52,152,219,0.2);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --primary-color: #3498db;
        --primary-dark: #2980b9;
        --text-color: #ecf0f1;
        --error-color: #e74c3c;
        --background-color: #1a1a1a;
        --card-background: #2c2c2c;
        --border-color: #444;
        --shadow-color: rgba(0,0,0,0.2);
        --focus-shadow: rgba(52,152,219,0.4);
      }
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      color: var(--text-color);
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }
    
    .login-container {
      width: 100%;
      max-width: 420px;
      text-align: center;
    }
    
    .logo {
      margin-bottom: 20px;
      max-width: 100px;
      height: auto;
    }
    
    h2 {
      color: var(--text-color);
      margin-bottom: 25px;
      font-size: 24px;
    }
    
    form {
      background: var(--card-background);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 5px 15px var(--shadow-color);
      display: flex;
      flex-direction: column;
      gap: 20px;
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      text-align: left;
    }
    
    label {
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-color);
      font-size: 14px;
      transition: color 0.3s;
    }
    
    input {
      padding: 14px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      transition: all 0.3s;
      background-color: var(--card-background);
      color: var(--text-color);
    }
    
    input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px var(--focus-shadow);
    }
    
    button {
      padding: 14px;
      font-size: 16px;
      border-radius: 8px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    button:hover:not(:disabled) {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    .error {
      color: var(--error-color);
      font-size: 14px;
      text-align: center;
      padding: 10px;
      border-radius: 6px;
      background-color: rgba(231, 76, 60, 0.1);
      display: none;
      transition: all 0.3s;
    }
    
    .error-shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }
    
    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
      40%, 60% { transform: translate3d(3px, 0, 0); }
    }
    
    .loader {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .footer {
      margin-top: 30px;
      font-size: 14px;
      color: var(--text-color);
      opacity: 0.7;
      text-align: center;
    }
    
    .footer a {
      color: var(--primary-color);
      text-decoration: none;
      transition: color 0.3s;
    }
    
    .footer a:hover {
      text-decoration: underline;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
    }
    
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    
    .password-container {
      position: relative;
    }
    
    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-color);
      opacity: 0.7;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .password-toggle:hover {
      opacity: 1;
      transform: translateY(-50%);
    }
    
    @media (max-width: 480px) {
      form {
        padding: 20px;
      }
      
      h2 {
        font-size: 20px;
      }
      
      input, button {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <!-- Opcional: Agregar logo -->
    <!-- <img src="logo.png" alt="Logo SDMO" class="logo"> -->
    
    <h2>Ingreso al Sistema SDMO</h2>
    
    <form id="loginForm" aria-labelledby="loginHeading">
      <div class="form-group">
        <label for="email">Correo electrónico</label>
        <input 
          type="email" 
          id="email" 
          placeholder="tu@email.com" 
          required
          autocomplete="username"
          aria-describedby="emailError"
        >
      </div>
      
      <div class="form-group">
        <label for="password">Contraseña</label>
        <div class="password-container">
          <input 
            type="password" 
            id="password" 
            placeholder="••••••••" 
            required
            autocomplete="current-password"
            aria-describedby="passwordError"
          >
          <button 
            type="button" 
            id="passwordToggle" 
            class="password-toggle" 
            aria-label="Mostrar/ocultar contraseña"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </button>
        </div>
      </div>
      
      <div class="checkbox-group">
        <div class="checkbox-container">
          <input type="checkbox" id="rememberMe">
          <label for="rememberMe">Recordarme</label>
        </div>
        <a href="#" tabindex="0">¿Olvidaste tu contraseña?</a>
      </div>
      
      <div id="errorMsg" class="error" role="alert" aria-live="assertive"></div>
      
      <button type="submit" id="submitBtn">
        Iniciar Sesión
      </button>
    </form>
    
    <div class="footer">
      <p>¿Problemas para ingresar? <a href="#" tabindex="0">Contactar soporte</a></p>
      <p style="margin-top: 10px;">&copy; 2025 Sistema SDMO. Todos los derechos reservados.</p>
    </div>
  </div>
</body>
</html>
