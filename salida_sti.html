<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Salida de Artículos - Cliente Interno</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://qpccqoeronbcdyejfjod.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwY2Nxb2Vyb25iY2R5ZWpmam9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyMzA5MzIsImV4cCI6MjA1OTgwNjkzMn0.v_KA6VdHl-F3sRiVaFMsfDQCS1qKERFBk5mTBcSiIDQ'
    );

    let articulosSeleccionados = [];

    document.addEventListener('DOMContentLoaded', async () => {
      await cargarInventario();
      document.getElementById('btnGuardar').addEventListener('click', guardarSalida);
    });

    async function cargarInventario() {
      const { data, error } = await supabase.from('inventario_actual').select('*');
      if (error) return alert('Error cargando inventario');
      const contenedor = document.getElementById('inventario');
      contenedor.innerHTML = '';
      data.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <img src="${item.imagen_url}" alt="Imagen" style="width:60px;cursor:pointer" ondblclick='seleccionarArticulo(${JSON.stringify(item)})'/>
          <p>${item.nombre_articulo}</p>
          <small>Stock: ${item.cantidad_disponible}</small>
        `;
        contenedor.appendChild(div);
      });
    }

    window.seleccionarArticulo = async (item) => {
      const cantidad = prompt(`Ingrese cantidad para: ${item.nombre_articulo}`);
      if (!cantidad || isNaN(cantidad)) return;
      articulosSeleccionados.push({ articulo: item.codigo_articulo, nombre: item.nombre_articulo, cantidad: parseFloat(cantidad) });
      mostrarArticulosSeleccionados();
    }

    function mostrarArticulosSeleccionados() {
      const tabla = document.getElementById('detalle');
      tabla.innerHTML = '<tr><th>Artículo</th><th>Cantidad</th></tr>';
      articulosSeleccionados.forEach(a => {
        tabla.innerHTML += `<tr><td>${a.nombre}</td><td>${a.cantidad}</td></tr>`;
      });
    }

    async function guardarSalida() {
      const autoriza = document.getElementById('autoriza').value;
      const retira = document.getElementById('retira').value;
      const vehiculo = document.getElementById('vehiculo').value;
      const operador = document.getElementById('operador').value;
      const solicitud = parseInt(document.getElementById('solicitud').value);

      if (!autoriza || !retira || !solicitud || articulosSeleccionados.length === 0) {
        alert('Complete todos los datos');
        return;
      }

      const { data: salida, error } = await supabase.from('salida_articulo_08').insert([{ 
        autoriza, retira, placa_vehiculo: vehiculo, operador_vehiculo: operador, numero_solicitud: solicitud, tipo_cliente: 'interno', fecha_salida: new Date().toISOString().split('T')[0]
      ]).select();

      if (error || !salida[0]) return alert('Error al guardar salida');

      const id_salida = salida[0].id_salida;

      const detalles = articulosSeleccionados.map(a => ({
        id_salida,
        articulo: a.articulo,
        cantidad: a.cantidad
      }));

      const { error: errorDetalles } = await supabase.from('dato_salida_13').insert(detalles);

      if (errorDetalles) return alert('Error al guardar detalles');

      alert('Salida registrada con éxito');
      location.reload();
    }
  </script>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f4f6f8; }
    label, input, select { display: block; margin: 8px 0; }
    .item { display: inline-block; width: 180px; margin: 10px; text-align: center; background: #fff; padding: 8px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; }
  </style>
</head>
<body>
  <h2>Registrar Salida para Cliente Interno</h2>
  <label>Autoriza: <input type="text" id="autoriza"></label>
  <label>Retira: <input type="text" id="retira"></label>
  <label>Vehículo: <input type="text" id="vehiculo"></label>
  <label>Operador: <input type="text" id="operador"></label>
  <label>N° de Solicitud: <input type="number" id="solicitud"></label>

  <h3>Inventario Disponible</h3>
  <div id="inventario" style="display:flex; flex-wrap:wrap;"></div>

  <h3>Artículos Seleccionados</h3>
  <table id="detalle">
    <tr><th>Artículo</th><th>Cantidad</th></tr>
  </table>

  <button id="btnGuardar">Guardar Salida</button>
</body>
</html>
