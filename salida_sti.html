<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario-Solicitudes-CI</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Configuraci√≥n Supabase
    const supabaseUrl = 'https://qpccqoeronbcdyejfjod.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwY2Nxb2Vyb25iY2R5ZWpmam9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyMzA5MzIsImV4cCI6MjA1OTgwNjkzMn0.v_KA6VdHl-F3sRiVaFMsfDQCS1qKERFBk5mTBcSiIDQ';
    const supabase = createClient(supabaseUrl, supabaseKey);

    let areasData = [], instalacionesData = [], supervisoresData = [], profesionalesData = [], clientesData = [];

    const escapeHtml = unsafe => unsafe ? unsafe.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;').replace(/'/g, '&#039;') : '';

    const ordenarAlfabeticamente = (arr, prop) => arr?.sort((a,b)=>
      (a[prop]||'').toString().localeCompare((b[prop]||'').toString(), 'es', { sensitivity: 'base' })
    )||[];

    async function obtenerProximoNumero() {
      const { data, error } = await supabase.from('solicitud_17')
        .select('numero_solicitud').order('numero_solicitud', { ascending: false }).limit(1);
      if (error) throw error;
      return data.length ? data[0].numero_solicitud + 1 : 1;
    }

    async function cargarDesplegables() {
      try {
        const [areas, inst, supv, prof, cli] = await Promise.all([
          supabase.from('area_mantenimiento_20').select('id_area_mantenimiento, descripcion_area'),
          supabase.from('instalaciones_municipales_16').select('id_instalacion_municipal, instalacion_municipal'),
          supabase.from('colaboradores_06').select('identificacion, alias').eq('supervisor', true).eq('condicion_laboral', false),
          supabase.from('colaboradores_06').select('identificacion, alias').eq('autorizado', true),
          supabase.from('cliente_interno_15').select('id_cliente, nombre')
        ]);

        areasData = ordenarAlfabeticamente(areas.data, 'descripcion_area');
        instalacionesData = ordenarAlfabeticamente(inst.data, 'instalacion_municipal');
        supervisoresData = ordenarAlfabeticamente(supv.data, 'alias');
        profesionalesData = ordenarAlfabeticamente(prof.data, 'alias');
        clientesData = ordenarAlfabeticamente(cli.data, 'nombre');

        const buildOptions = (data, valKey, txtKey) => {
          let opts = '<option value="" disabled selected>-- Seleccione una opci√≥n --</option>';
          ordenarAlfabeticamente(data, txtKey).forEach(o => {
            opts += `<option value="${escapeHtml(o[valKey])}">${escapeHtml(o[txtKey])}</option>`;
          });
          return opts;
        };

        document.getElementById('area_mantenimiento').innerHTML = buildOptions(areas.data, 'id_area_mantenimiento', 'descripcion_area');
        document.getElementById('instalacion_municipal').innerHTML = buildOptions(inst.data, 'id_instalacion_municipal', 'instalacion_municipal');
        document.getElementById('supervisor_asignado').innerHTML = buildOptions(supervisoresData, 'identificacion', 'alias');
        document.getElementById('profesional_responsable').innerHTML = buildOptions(profesionalesData, 'identificacion', 'alias');
        document.getElementById('cliente_interno').innerHTML = buildOptions(clientesData, 'id_cliente', 'nombre');
      } catch(e) {
        console.error('Error desplegables', e);
        alert('No se pudieron cargar los selects');
      }
    }

    async function cargarTabla(filtro='') {
      const { data, error } = await supabase.from('solicitud_17')
        .select('*').eq('tipo_solicitud','STI').order('numero_solicitud',{ascending:false}).limit(100);
      if (error) return console.error(error);
      let arr = data.filter(s=>
        s.numero_solicitud.toString().includes(filtro.toLowerCase()) ||
        (s.descripcion_solicitud||'').toLowerCase().includes(filtro.toLowerCase())
      ).slice(0,5);

      const tbody = document.getElementById('tablaSolicitudes');
      tbody.innerHTML = '';
      if(!arr.length) return tbody.innerHTML = '<tr><td colspan="4">No se encontraron registros</td></tr>';
      arr.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.numero_solicitud}</td>
          <td>${escapeHtml(s.descripcion_solicitud)}</td>
          <td>${new Date(s.fecha_solicitud).toLocaleDateString()}</td>
          <td>${s.area_mantenimiento||'-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.showModalSalidaSTI = () => {
      const modal = document.getElementById('modalSalidaSTI');
      const ifr = document.getElementById('iframeSalidaSTI');
      if (!ifr.src) ifr.src = ifr.dataset.src;
      modal.style.display = 'block';
    };
    window.closeModalSalidaSTI = () => document.getElementById('modalSalidaSTI').style.display='none';

    window.addEventListener('DOMContentLoaded', async()=>{
      await cargarDesplegables();
      await cargarTabla();
      document.getElementById('busqueda').addEventListener('input', e=> cargarTabla(e.target.value));
      document.getElementById('registrarSTI').addEventListener('click', window.showModalSalidaSTI);
      document.getElementById('modalSalidaSTI').addEventListener('click', e=>{
        if(e.target.id==='modalSalidaSTI') window.closeModalSalidaSTI();
      });
    });
  </script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Segoe UI',sans-serif;background:#f4f6f8;padding:20px;color:#333}
    .container{max-width:1200px;margin:0 auto}
    h1,h2{color:#2c3e50;margin-bottom:15px}
    .form-group{margin-bottom:12px;position:relative}
    label{display:block;font-weight:600}
    input,select,textarea{width:100%;max-width:500px;padding:10px;border:1px solid #ddd;border-radius:4px}
    button{padding:10px 20px;border:none;border-radius:4px;background:#3498db;color:#fff;cursor:pointer;transition:0.2s}
    button:hover{background:#2980b9}
    table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff}
    th,td{padding:12px;border:1px solid #ddd}
    th{background:#3498db;color:#fff;text-align:left}
    tr:hover{background:#f5f5f5}

    /* Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1001}
    .modal-content-large{background:#fff;margin:2% auto;padding:0;width:95%;max-width:1200px;position:relative;border-radius:6px}
    .modal-content-large .close{position:absolute;top:10px;right:20px;font-size:28px;color:#aaa;cursor:pointer}
    .modal-content-large .close:hover{color:#333}
  </style>
</head>
<body>
  <div class="container">
    <h1>Formulario para ingreso de solicitudes de cliente interno</h1>

    <!-- Campos del formulario -->
    <div class="form-group">
      <label for="descripcion_solicitud">Descripci√≥n de la solicitud:</label>
      <textarea id="descripcion_solicitud" placeholder="Describa la solicitud..."></textarea>
    </div>
    <div class="form-group">
      <label for="area_mantenimiento">√Årea de Mantenimiento:</label>
      <select id="area_mantenimiento"></select>
      <button class="btn" onclick="abrirModalBusqueda('area')">üîç</button>
    </div>
    <!-- (Repite estructura para los dem√°s selects...) -->

    <div class="form-group">
      <button id="registrarSTI">‚ûï Registrar Nueva Salida STI</button>
    </div>

    <!-- B√∫squeda activa -->
    <div class="form-group">
      <label for="busqueda">Buscar por # Solicitud o Descripci√≥n:</label>
      <input type="text" id="busqueda" placeholder="Ej: 8461 o vestimenta">
    </div>

    <h2>√öltimas 5 Solicitudes Registradas</h2>
    <table>
      <thead>
        <tr>
          <th># Solicitud</th><th>Descripci√≥n</th><th>Fecha</th><th>√Årea</th>
        </tr>
      </thead>
      <tbody id="tablaSolicitudes">
        <tr><td colspan="4">Cargando datos...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Modal de Salida STI -->
  <div id="modalSalidaSTI" class="modal">
    <div class="modal-content-large">
      <span class="close" onclick="closeModalSalidaSTI()">&times;</span>
      <iframe
        id="iframeSalidaSTI"
        data-src="./salida_sti.html"
        src=""
        frameborder="0"
        style="width:100%;height:90vh;border:none;"
      ></iframe>
    </div>
  </div>
</body>
</html>

  <button id="btnGuardar">Guardar Salida</button>
</body>
</html>
