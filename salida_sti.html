<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registrar Salida Cliente Interno</title>

  <!-- Import supabase -->
  <script type="importmap">
    {
      "imports": {
        "@supabase/supabase-js": "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"
      }
    }
  </script>
  <script type="module">
    import { createClient } from '@supabase/supabase-js';

    // --- CONFIGURACI√ìN SUPABASE ---
    const supabase = createClient(
      'https://qpccqoeronbcdyejfjod.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9‚Ä¶' // tu clave p√∫blica
    );

    let articulosSeleccionados = [];

    document.addEventListener('DOMContentLoaded', () => {
      cargarInventario();
      document.getElementById('btnGuardar').onclick = guardarSalida;
    });

    // 1) Carga inventario_actual y pinta tarjetas
    async function cargarInventario() {
      const { data, error } = await supabase
        .from('inventario_actual')
        .select('codigo_articulo,nombre_articulo,cantidad_disponible,imagen_url');
      if (error) {
        console.error(error);
        return alert('No pude cargar el inventario');
      }
      const cont = document.getElementById('inventario');
      cont.innerHTML = '';
      data.forEach(item => {
        const card = document.createElement('div');
        card.className = 'item';
        card.innerHTML = `
          <img 
            src="${item.imagen_url||'placeholder.png'}" 
            alt="${item.nombre_articulo}" 
            ondblclick="seleccionarArticulo('${item.codigo_articulo}','${item.nombre_articulo.replace(/'/g,"\\'")}')" 
          />
          <p>${item.nombre_articulo}</p>
          <small>Stock: ${item.cantidad_disponible}</small>
        `;
        cont.appendChild(card);
      });
    }

    // 2) Al hacer doble clic, pide cantidad y a√±ade al array
    window.seleccionarArticulo = (codigo, nombre) => {
      const cant = prompt(`¬øCu√°ntas unidades de:\n${nombre}\nquieres agregar?`);
      const n = parseFloat(cant);
      if (!n || n <= 0) return;
      articulosSeleccionados.push({ codigo, nombre, cantidad: n });
      renderizarDetalle();
    };

    function renderizarDetalle() {
      const tbody = document.getElementById('detalle');
      tbody.innerHTML = '<tr><th>Art√≠culo</th><th>Cantidad</th></tr>';
      articulosSeleccionados.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.nombre}</td>
          <td style="text-align:right;">${a.cantidad}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 3) Guarda en salida_articulo_08 y luego en dato_salida_13
    async function guardarSalida() {
      const autoriza = document.getElementById('autoriza').value.trim();
      const retira   = document.getElementById('retira').value.trim();
      const vehiculo = document.getElementById('vehiculo').value.trim();
      const operador = document.getElementById('operador').value.trim();
      const solicitud= parseInt(document.getElementById('solicitud').value,10);

      if (!autoriza||!retira||!solicitud||articulosSeleccionados.length===0) {
        return alert('Por favor completa todos los campos y selecciona al menos un art√≠culo.');
      }

      // Inserta cabecera
      const { data: [ cabecera ], error: errCab } = await supabase
        .from('salida_articulo_08')
        .insert([{
          autoriza,
          retira,
          placa_vehiculo: vehiculo,
          operador_vehiculo: operador,
          numero_solicitud: solicitud,
          tipo_cliente: 'interno',
          fecha_salida: new Date().toISOString().split('T')[0]
        }])
        .select('id_salida')
        .single();

      if (errCab) {
        console.error(errCab);
        return alert('Fallo al guardar la cabecera de la salida');
      }

      // Inserta detalle
      const detalles = articulosSeleccionados.map(a => ({
        id_salida: cabecera.id_salida,
        articulo: a.codigo,
        cantidad: a.cantidad
      }));
      const { error: errDet } = await supabase
        .from('dato_salida_13')
        .insert(detalles);

      if (errDet) {
        console.error(errDet);
        return alert('Fallo al guardar el detalle de la salida');
      }

      alert('Salida registrada con √©xito üéâ');
      // recarga o limpia
      articulosSeleccionados = [];
      renderizarDetalle();
    }
  </script>

  <style>
    * { box-sizing: border-box; margin:0; padding:0 }
    body { font-family:sans-serif; background:#f4f4f4; padding:20px }
    h2 { margin-bottom:10px }
    label { display:block; margin-top:10px; font-weight:600 }
    input { width:100%; padding:8px; margin-top:4px; border:1px solid #ccc; border-radius:4px }
    #inventario { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px }
    .item {
      background:#fff; padding:8px; border-radius:6px; text-align:center;
      box-shadow:0 1px 4px rgba(0,0,0,0.1); width:140px
    }
    .item img {
      width:100%; height:100px; object-fit:contain; cursor:pointer;
      border:1px solid #ddd; border-radius:4px
    }
    table { width:100%; border-collapse:collapse; margin-top:10px }
    th,td { padding:8px; border:1px solid #ccc }
    th { background:#3498db; color:#fff }
    #btnGuardar {
      margin-top:15px; padding:10px 20px; background:#27ae60; color:#fff;
      border:none; border-radius:4px; cursor:pointer;
    }
  </style>
</head>

<body>
  <h2>Registrar Salida de Art√≠culos (Cliente Interno)</h2>

  <label>Autoriza:
    <input type="text" id="autoriza"/>
  </label>
  <label>Retira:
    <input type="text" id="retira"/>
  </label>
  <label>Veh√≠culo (placa):
    <input type="text" id="vehiculo"/>
  </label>
  <label>Operador:
    <input type="text" id="operador"/>
  </label>
  <label>N¬∞ de Solicitud de Trabajo:
    <input type="number" id="solicitud"/>
  </label>

  <h3>Inventario Disponible (doble‚Äêclic en imagen para seleccionar)</h3>
  <div id="inventario">Cargando‚Ä¶</div>

  <h3>Art√≠culos Seleccionados</h3>
  <table>
    <tbody id="detalle">
      <tr><th>Art√≠culo</th><th>Cantidad</th></tr>
    </tbody>
  </table>

  <button id="btnGuardar">Guardar Salida</button>
</body>
</html>
