<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Salida de Artículos - Cliente Interno</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://qpccqoeronbcdyejfjod.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwY2Nxb2Vyb25iY2R5ZWpmam9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyMzA5MzIsImV4cCI6MjA1OTgwNjkzMn0.v_KA6VdHl-F3sRiVaFMsfDQCS1qKERFBk5mTBcSiIDQ'
    );

    let articulosSeleccionados = [];

    // Esperamos a que cargue la página
    document.addEventListener('DOMContentLoaded', async () => {
      await cargarInventario();
      document.getElementById('btnGuardar').addEventListener('click', guardarSalida);
    });

    // 1) Carga y muestra el inventario
    async function cargarInventario() {
      const { data, error } = await supabase
        .from('inventario_actual')
        .select('*');
      if (error) {
        console.error('Error cargando inventario', error);
        return;
      }
      const contenedor = document.getElementById('inventario');
      contenedor.innerHTML = '';
      data.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item';
        //  —> Aquí corregimos ondblclick para pasar solo los campos necesarios
        div.innerHTML = `
          <img
            src="${item.imagen_url}"
            alt="${item.nombre_articulo}"
            style="width:60px; cursor:pointer;"
            ondblclick="seleccionarArticulo('${item.codigo_articulo}', '${item.nombre_articulo}')"
          />
          <p>${item.nombre_articulo}</p>
          <small>Stock: ${item.cantidad_disponible ?? 0}</small>
        `;
        contenedor.appendChild(div);
      });
    }

    // 2) Función global (window) que recibe código y nombre
    window.seleccionarArticulo = (codigo, nombre) => {
      const cantidad = prompt(`Ingrese cantidad para: ${nombre}`);
      if (!cantidad || isNaN(cantidad)) return;
      articulosSeleccionados.push({
        articulo: codigo,
        nombre: nombre,
        cantidad: parseFloat(cantidad)
      });
      mostrarArticulosSeleccionados();
    };

    // 3) Refresca la tabla de artículos seleccionados
    function mostrarArticulosSeleccionados() {
      const tabla = document.getElementById('detalle');
      tabla.innerHTML = '<tr><th>Artículo</th><th>Cantidad</th></tr>';
      articulosSeleccionados.forEach(a => {
        tabla.innerHTML += `
          <tr>
            <td>${a.nombre}</td>
            <td>${a.cantidad}</td>
          </tr>
        `;
      });
    }

    // 4) Guarda la salida y los detalles en Supabase
    async function guardarSalida() {
      const autoriza = document.getElementById('autoriza').value.trim();
      const retira = document.getElementById('retira').value.trim();
      const vehiculo = document.getElementById('vehiculo').value.trim();
      const operador = document.getElementById('operador').value.trim();
      const solicitud = parseInt(document.getElementById('solicitud').value);

      if (!autoriza || !retira || !solicitud || articulosSeleccionados.length === 0) {
        alert('Complete todos los datos y seleccione al menos un artículo.');
        return;
      }

      // Inserta encabezado de salida
      const { data: salida, error } = await supabase
        .from('salida_articulo_08')
        .insert([{
          autoriza,
          retira,
          placa_vehiculo: vehiculo,
          operador_vehiculo: operador,
          numero_solicitud: solicitud,
          tipo_cliente: 'interno',
          fecha_salida: new Date().toISOString().split('T')[0]
        }])
        .select();

      if (error || !salida.length) {
        console.error('Error guardando salida', error);
        return alert('Error al guardar la salida.');
      }

      const id_salida = salida[0].id_salida;

      // Inserta cada detalle
      const detalles = articulosSeleccionados.map(a => ({
        id_salida,
        articulo: a.articulo,
        cantidad: a.cantidad
      }));
      const { error: errDet } = await supabase
        .from('dato_salida_13')
        .insert(detalles);

      if (errDet) {
        console.error('Error guardando detalles', errDet);
        return alert('Error al guardar los ítems.');
      }

      alert('Salida registrada con éxito.');
      location.reload();
    }
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f6f8;
    }
    label, input {
      display: block;
      margin: 8px 0;
      width: 300px;
    }
    .item {
      display: inline-block;
      width: 180px;
      margin: 8px;
      padding: 8px;
      text-align: center;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background-color: #3498db;
      color: #fff;
      text-align: left;
    }
    button {
      margin-top: 20px;
      padding: 10px 16px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #2980b9;
    }
  </style>
</head>

<body>
  <h2>Registrar Salida para Cliente Interno</h2>

  <label>Autoriza:
    <input type="text" id="autoriza" placeholder="Quien autoriza...">
  </label>

  <label>Retira:
    <input type="text" id="retira" placeholder="Quien retira...">
  </label>

  <label>Vehículo:
    <input type="text" id="vehiculo" placeholder="Placa vehicular">
  </label>

  <label>Operador:
    <input type="text" id="operador" placeholder="Nombre operador">
  </label>

  <label>N° de Solicitud:
    <input type="number" id="solicitud" placeholder="Número de solicitud">
  </label>

  <h3>Inventario Disponible</h3>
  <div id="inventario" style="display:flex; flex-wrap:wrap;"></div>

  <h3>Artículos Seleccionados</h3>
  <table id="detalle">
    <tr><th>Artículo</th><th>Cantidad</th></tr>
  </table>

  <button id="btnGuardar">Guardar Salida</button>
</body>
</html>
