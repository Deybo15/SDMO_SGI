<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicitudes Cliente Interno</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Configuración Supabase (igual que antes)
    const supabaseUrl = 'https://qpccqoeronbcdyejfjod.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwY2Nxb2Vyb25iY2R5ZWpmam9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyMzA5MzIsImV4cCI6MjA1OTgwNjkzMn0.v_KA6VdHl-F3sRiVaFMsfDQCS1qKERFBk5mTBcSiIDQ';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Variables y funciones originales (sin cambios)
    let areasData = [];
    let instalacionesData = [];
    let supervisoresData = [];
    let profesionalesData = [];
    let clientesData = [];

    const escapeHtml = (unsafe) => {
      if (!unsafe) return '';
      return unsafe.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    };

    const ordenarAlfabeticamente = (array, propiedad) => {
      return array?.sort((a, b) => {
        const textA = a[propiedad]?.toString().toUpperCase() || '';
        const textB = b[propiedad]?.toString().toUpperCase() || '';
        return textA.localeCompare(textB);
      }) || [];
    };

    async function obtenerProximoNumero() {
      try {
        const { data, error } = await supabase
          .from("solicitud_cliente_interno")
          .select('numero_solicitud')
          .order('numero_solicitud', { ascending: false })
          .limit(1);
        
        if (error) throw error;
        
        return data.length > 0 ? data[0].numero_solicitud + 1 : 1;
      } catch (error) {
        console.error("Error obteniendo número de solicitud:", error);
        throw error;
      }
    }

    async function cargarDesplegables() {
      try {
        const [areas, instalaciones, supervisores, profesionales, clientes] = await Promise.all([
          supabase.from("area_mantenimiento_20").select("id_area_mantenimiento, descripcion_area"),
          supabase.from("instalaciones_municipales_16").select("id_instalacion_municipal, instalacion_municipal"),
          supabase
            .from("colaboradores_06")
            .select("identificacion, alias")
            .eq("supervisor", true)
            .eq("condicion_laboral", false),
          supabase.from("colaboradores_06").select("identificacion, alias").eq("autorizado", true),
          supabase.from("cliente_interno_15").select("id_cliente, nombre")
        ]);

        areasData = ordenarAlfabeticamente(areas?.data, 'descripcion_area') || [];
        instalacionesData = ordenarAlfabeticamente(instalaciones?.data, 'instalacion_municipal') || [];
        supervisoresData = ordenarAlfabeticamente(supervisores?.data, 'alias') || [];
        profesionalesData = ordenarAlfabeticamente(profesionales?.data, 'alias') || [];
        clientesData = ordenarAlfabeticamente(clientes?.data, 'nombre') || [];

        const buildOptions = (data, valueKey, textKey) => {
          const datosOrdenados = ordenarAlfabeticamente(data?.data, textKey);
          let options = '<option value="" selected disabled>-- Seleccione una opción --</option>';
          options += datosOrdenados.map(opt => 
            `<option value="${escapeHtml(opt[valueKey])}">${escapeHtml(opt[textKey])}</option>`
          ).join('');
          return options;
        };

        document.getElementById("area_mantenimiento").innerHTML = buildOptions(areas, 'id_area_mantenimiento', 'descripcion_area');
        document.getElementById("instalacion_municipal").innerHTML = buildOptions(instalaciones, 'id_instalacion_municipal', 'instalacion_municipal');
        document.getElementById("supervisor_asignado").innerHTML = buildOptions(supervisores, 'identificacion', 'alias');
        document.getElementById("profesional_responsable").innerHTML = buildOptions(profesionales, 'identificacion', 'alias');
        document.getElementById("cliente_interno").innerHTML = buildOptions(clientes, 'id_cliente', 'nombre');
      } catch (error) {
        console.error("Error cargando desplegables:", error);
        showNotification("Error al cargar los datos de los select", "error");
      }
    }

    function abrirModalBusqueda(tipo) {
      const modal = new bootstrap.Modal(document.getElementById('modalBusqueda'));
      const tituloModal = document.getElementById('tituloModal');
      const inputBusqueda = document.getElementById('inputBusqueda');
      
      let datos = [];
      let campoTexto = '';
      let campoValor = '';
      
      switch(tipo) {
        case 'area':
          datos = areasData;
          campoTexto = 'descripcion_area';
          campoValor = 'id_area_mantenimiento';
          tituloModal.textContent = 'Buscar Área de Mantenimiento';
          break;
        case 'instalacion':
          datos = instalacionesData;
          campoTexto = 'instalacion_municipal';
          campoValor = 'id_instalacion_municipal';
          tituloModal.textContent = 'Buscar Instalación Municipal';
          break;
        case 'supervisor':
          datos = supervisoresData;
          campoTexto = 'alias';
          campoValor = 'identificacion';
          tituloModal.textContent = 'Buscar Supervisor';
          break;
        case 'profesional':
          datos = profesionalesData;
          campoTexto = 'alias';
          campoValor = 'identificacion';
          tituloModal.textContent = 'Buscar Profesional';
          break;
        case 'cliente':
          datos = clientesData;
          campoTexto = 'nombre';
          campoValor = 'id_cliente';
          tituloModal.textContent = 'Buscar Cliente Interno';
          break;
      }
      
      document.getElementById('modalBusqueda').dataset.tipo = tipo;
      document.getElementById('modalBusqueda').dataset.campoTexto = campoTexto;
      document.getElementById('modalBusqueda').dataset.campoValor = campoValor;
      
      mostrarResultados(datos, campoTexto);
      
      inputBusqueda.oninput = () => {
        const termino = inputBusqueda.value.toLowerCase();
        const resultados = datos.filter(item => 
          item[campoTexto].toLowerCase().includes(termino)
        );
        mostrarResultados(resultados, campoTexto);
      };
      
      modal.show();
    }

    function mostrarResultados(resultados, campoTexto) {
      const listaResultados = document.getElementById('listaResultados');
      listaResultados.innerHTML = '';
      
      if (resultados.length === 0) {
        listaResultados.innerHTML = '<li class="list-group-item text-muted">No se encontraron resultados</li>';
        return;
      }
      
      resultados.forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.textContent = item[campoTexto];
        li.onclick = () => seleccionarItem(item);
        listaResultados.appendChild(li);
      });
    }

    function seleccionarItem(item) {
      const modal = document.getElementById('modalBusqueda');
      const tipo = modal.dataset.tipo;
      const campoValor = modal.dataset.campoValor;
      const campoTexto = modal.dataset.campoTexto;
      
      let selectId = '';
      switch(tipo) {
        case 'area': selectId = 'area_mantenimiento'; break;
        case 'instalacion': selectId = 'instalacion_municipal'; break;
        case 'supervisor': selectId = 'supervisor_asignado'; break;
        case 'profesional': selectId = 'profesional_responsable'; break;
        case 'cliente': selectId = 'cliente_interno'; break;
      }
      
      const select = document.getElementById(selectId);
      if (select) {
        for (let i = 0; i < select.options.length; i++) {
          if (select.options[i].value === item[campoValor].toString()) {
            select.selectedIndex = i;
            break;
          }
        }
      }
      
      bootstrap.Modal.getInstance(modal).hide();
    }

    function resetForm() {
      document.getElementById("descripcion_solicitud").value = "";
      
      const selects = [
        "area_mantenimiento", 
        "instalacion_municipal",
        "supervisor_asignado", 
        "profesional_responsable", 
        "cliente_interno"
      ];
      
      selects.forEach(id => {
        const select = document.getElementById(id);
        if (select) select.selectedIndex = 0;
      });
    }

    async function guardarSolicitud() {
      try {
        const descripcion = document.getElementById("descripcion_solicitud").value.trim();
        const area_mantenimiento = document.getElementById("area_mantenimiento").value;
        const instalacion_municipal = document.getElementById("instalacion_municipal").value;
        const supervisor_asignado = document.getElementById("supervisor_asignado").value;
        const profesional_responsable = document.getElementById("profesional_responsable").value;
        const cliente_interno = document.getElementById("cliente_interno").value;

        if (!descripcion) {
          showNotification("La descripción es requerida", "error");
          document.getElementById("descripcion_solicitud").focus();
          return;
        }

        const selects = ["area_mantenimiento", "instalacion_municipal", 
                        "supervisor_asignado", "profesional_responsable", 
                        "cliente_interno"];
        
        for (const selectId of selects) {
          const select = document.getElementById(selectId);
          if (!select.value) {
            const label = document.querySelector(`label[for="${selectId}"]`).textContent;
            showNotification(`Por favor seleccione una opción en ${label}`, "error");
            select.focus();
            return;
          }
        }

        const submitBtn = document.querySelector("#btn-guardar");
        submitBtn.innerHTML = `
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Guardando...
        `;
        submitBtn.disabled = true;

        const proximoNumero = await obtenerProximoNumero();

        const { data, error } = await supabase.from("solicitud_cliente_interno").insert([{
          numero_solicitud: proximoNumero,
          id_solicitud_sa: null,
          tipo_solicitud: "STI",
          fecha_solicitud: new Date().toISOString().split("T")[0],
          area_mantenimiento,
          tipologia_trabajo: null,
          descripcion_solicitud: escapeHtml(descripcion),
          barrio_solicitud: null,
          direccion_exacta: null,
          latitud: null,
          longitud: null,
          link_ubicacion: null,
          imagen_ubicacion: null,
          instalacion_municipal,
          supervisor_asignado,
          profesional_responsable,
          cliente_interno,
          cliente_externo: null,
          numero_activo: null,
          dependencia_municipal: null
        }]).select();

        if (error) throw error;

        showNotification(`Solicitud #${proximoNumero} guardada exitosamente`, "success");
        resetForm();
        document.getElementById("descripcion_solicitud").focus();
        await cargarTabla();
      } catch (error) {
        console.error("Error guardando solicitud:", error);
        showNotification("Error al guardar la solicitud: " + error.message, "error");
      } finally {
        const submitBtn = document.querySelector("#btn-guardar");
        if (submitBtn) {
          submitBtn.innerHTML = '<i class="fas fa-save me-2"></i> Guardar Solicitud';
          submitBtn.disabled = false;
        }
      }
    }

    

    function showNotification(message, type = "info") {
      const notification = document.createElement("div");
      notification.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0`;
      notification.setAttribute('role', 'alert');
      notification.setAttribute('aria-live', 'assertive');
      notification.setAttribute('aria-atomic', 'true');
      notification.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      
      const toastContainer = document.getElementById('toastContainer');
      toastContainer.appendChild(notification);
      const toast = new bootstrap.Toast(notification);
      toast.show();
      
      notification.addEventListener('hidden.bs.toast', () => {
        notification.remove();
      });
    }

    window.guardarSolicitud = guardarSolicitud;
    window.abrirModalBusqueda = abrirModalBusqueda;

    window.addEventListener("DOMContentLoaded", async () => {
      await cargarDesplegables();
      await cargarTabla();

      document.getElementById('busqueda').addEventListener('input', async (e) => {
        const termino = e.target.value;
        await cargarTabla(termino);
      });
    });

  
let currentPage = 1;
const itemsPerPage = 15;
let totalItems = 0;


  </style>
</head>
<body>
  <div class="main-container">
    <div id="toastContainer" class="toast-container"></div>
    
    <div class="card">
      <div class="card-header">
        <h1 class="h4 mb-0"><i class="fas fa-file-alt me-2"></i>SOLICITUDES DE CLIENTE INTERNO</h1>
      </div>
      
      <div class="card-body">
        <!-- Formulario de solicitud (intacto) -->
        <div class="form-section">
          <h3 class="section-title"><i class="fas fa-edit me-2"></i>Nueva Solicitud</h3>
          
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="descripcion_solicitud" class="form-label required-field">Descripción de la solicitud</label>
              <textarea id="descripcion_solicitud" class="form-control" placeholder="Describa detalladamente la solicitud..."></textarea>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="area_mantenimiento" class="form-label required-field">Área de Mantenimiento</label>
              <div class="select-container">
                <select id="area_mantenimiento" class="form-select"></select>
                <button class="btn-search" onclick="abrirModalBusqueda('area')">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="instalacion_municipal" class="form-label required-field">Instalación Municipal</label>
              <div class="select-container">
                <select id="instalacion_municipal" class="form-select"></select>
                <button class="btn-search" onclick="abrirModalBusqueda('instalacion')">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="supervisor_asignado" class="form-label required-field">Supervisor Asignado</label>
              <div class="select-container">
                <select id="supervisor_asignado" class="form-select"></select>
                <button class="btn-search" onclick="abrirModalBusqueda('supervisor')">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="profesional_responsable" class="form-label required-field">Profesional Responsable</label>
              <div class="select-container">
                <select id="profesional_responsable" class="form-select"></select>
                <button class="btn-search" onclick="abrirModalBusqueda('profesional')">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="cliente_interno" class="form-label required-field">Cliente Interno</label>
              <div class="select-container">
                <select id="cliente_interno" class="form-select"></select>
                <button class="btn-search" onclick="abrirModalBusqueda('cliente')">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
          </div>
          
          <div class="d-flex justify-content-between mt-4">
            <button onclick="window.location.href='inicio.html'" class="btn btn-secondary" type="button">
              <i class="fas fa-arrow-left me-2"></i> Volver al Inicio
            </button>
            <button id="btn-guardar" onclick="guardarSolicitud()" class="btn btn-primary">
              <i class="fas fa-save me-2"></i> Guardar Solicitud
            </button>
          </div>
        </div>
        
        <!-- Tabla de historial (modificado solo el botón) -->
        <div class="form-section">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="section-title mb-0"><i class="fas fa-list me-2"></i>Historial de Solicitudes</h3>
            
            <div class="d-flex">
              <div class="input-group me-3" style="width: 250px;">
                <input type="text" id="busqueda" class="form-control" placeholder="Buscar por # o descripción...">
                <button class="btn btn-outline-primary" type="button">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              
              <!-- Botón original eliminado aquí -->
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th># Solicitud</th>
                  <th>Descripción</th>
                  <th>Fecha</th>
                  
                </tr>
              </thead>
              <tbody id="tablaSolicitudes">
                <tr>
                  <td colspan="4" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Cargando...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
<div class="d-flex justify-content-center align-items-center my-3">
  <button id="btnAnterior" class="btn btn-secondary me-2" onclick="anteriorPagina()">Anterior</button>
  <span id="paginaActual" class="mx-2">Página 1</span>
  <button id="btnSiguiente" class="btn btn-secondary ms-2" onclick="siguientePagina()">Siguiente</button>
</div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de búsqueda (intacto) -->
  <div class="modal fade" id="modalBusqueda" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="tituloModal">Buscar</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="text" id="inputBusqueda" class="form-control" placeholder="Escriba para buscar...">
          </div>
          <ul id="listaResultados" class="list-group" style="max-height: 400px; overflow-y: auto;"></ul>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
let currentPage = 1;
const itemsPerPage = 15;
let totalItems = 0;

async function cargarTabla(filtro = '') {
  try {
    let query = supabase.from("solicitud_cliente_interno").select("*", { count: "exact" }).eq("tipo_solicitud", "STI");

    if (filtro) {
      const filtroLower = filtro.toLowerCase();
      query = query.or(`
        numero_solicitud.ilike.%${filtroLower}%,
        descripcion_solicitud.ilike.%${filtroLower}%
      `);
    }

    const { data, count, error } = await query
      .order("numero_solicitud", { ascending: false })
      .range((currentPage-1)*itemsPerPage, currentPage*itemsPerPage-1);

    if (error) throw error;

    totalItems = count || 0;
    renderizarTabla(data || []);
    actualizarPaginacion();
  } catch (error) {
    console.error("Error cargando solicitudes:", error);
    showNotification("Error al cargar las solicitudes", "error");
  }
}

function renderizarTabla(rows) {
  const tbody = document.getElementById("tablaSolicitudes");
  tbody.innerHTML = "";

  if (rows.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="3" class="text-center py-4">No se encontraron solicitudes</td>
      </tr>`;
    return;
  }

  rows.forEach(solicitud => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="fw-bold">${solicitud.numero_solicitud}</td>
      <td>${escapeHtml(solicitud.descripcion_solicitud || '')}</td>
      <td>${solicitud.fecha_solicitud ? new Date(solicitud.fecha_solicitud).toLocaleDateString('es-ES') : ''}</td>
    `;
    tbody.appendChild(row);
  });
}

function actualizarPaginacion() {
  const pageInfo = document.getElementById('paginaActual');
  const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
  pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
  document.getElementById('btnAnterior').disabled = currentPage === 1;
  document.getElementById('btnSiguiente').disabled = currentPage >= totalPages;
}

function anteriorPagina() {
  if (currentPage > 1) {
    currentPage--;
    cargarTabla(document.getElementById('busqueda').value);
  }
}

function siguientePagina() {
  const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
  if (currentPage < totalPages) {
    currentPage++;
    cargarTabla(document.getElementById('busqueda').value);
  }
}


let currentPage = 1;
const itemsPerPage = 15;
let totalItems = 0;

async function cargarTabla() {
  const termino = document.getElementById('busqueda').value.trim().toLowerCase();

  let query = supabase.from('solicitud_cliente_interno').select('*', { count: 'exact' });

  if (termino) {
    query = query.or(`
      numero_solicitud.ilike.%${termino}%,
      descripcion_solicitud.ilike.%${termino}%
    `);
  }

  const { data, count, error } = await query
    .order('numero_solicitud', { ascending: false })
    .range((currentPage - 1) * itemsPerPage, (currentPage * itemsPerPage) - 1);

  if (error) return console.error('Supabase:', error);

  totalItems = count || 0;
  renderizarTabla(data || []);
  actualizarPaginacion();
}

function renderizarTabla(rows) {
  const tbody = document.getElementById('tablaSolicitudes');
  tbody.innerHTML = '';
  if (rows.length === 0) {
    tbody.innerHTML = `
      <tr><td colspan="3" class="text-center py-4">No se encontraron solicitudes</td></tr>`;
    return;
  }

  rows.forEach(solicitud => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="fw-bold">${solicitud.numero_solicitud}</td>
      <td>${escapeHtml(solicitud.descripcion_solicitud || '')}</td>
      <td>${solicitud.fecha_solicitud ? new Date(solicitud.fecha_solicitud).toLocaleDateString('es-ES') : ''}</td>
    `;
    tbody.appendChild(row);
  });
}

function actualizarPaginacion() {
  const pageInfo = document.getElementById('paginaActual');
  const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
  pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
  document.getElementById('btnAnterior').disabled = currentPage === 1;
  document.getElementById('btnSiguiente').disabled = currentPage >= totalPages;
}

function anteriorPagina() {
  if (currentPage > 1) {
    currentPage--;
    cargarTabla();
  }
}

function siguientePagina() {
  const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
  if (currentPage < totalPages) {
    currentPage++;
    cargarTabla();
  }
}

document.getElementById('busqueda').addEventListener('input', () => {
  currentPage = 1;
  cargarTabla();
});

</script>
</body>
</html>
