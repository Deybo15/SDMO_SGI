<script>
  const supabaseUrl = 'https://qpccqoeronbcdyejfjod.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwY2Nxb2Vyb25iY2R5ZWpmam9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyMzA5MzIsImV4cCI6MjA1OTgwNjkzMn0.v_KA6VdHl-F3sRiVaFMsfDQCS1qKERFBk5mTBcSiIDQ';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  const form = document.getElementById('formSalida');
  const selectAutoriza = document.getElementById('autoriza');

  // ✅ Cargar los colaboradores autorizados
  async function cargarColaboradores() {
    const { data, error } = await supabase
      .from('colaboradores_06')
      .select('identificacion, alias')
      .eq('autorizado', true);

    if (error) {
      console.error("Error al cargar colaboradores:", error.message);
      return;
    }

    // Limpiar primero
    selectAutoriza.innerHTML = `<option value="">Seleccione quien autoriza</option>`;

    // Agregar las opciones
    data.forEach(colab => {
      const option = document.createElement('option');
      option.value = colab.identificacion; // se guarda esto
      option.textContent = colab.alias; // se muestra esto
      selectAutoriza.appendChild(option);
    });
  }

  cargarColaboradores();

  // ✅ Manejo del formulario
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const { error } = await supabase
      .from('salida_articulo_08')
      .insert([{
        numero_solicitud: parseInt(document.getElementById('numero_solicitud').value),
        autoriza: document.getElementById('autoriza').value, // guarda identificación
        retira: document.getElementById('retira').value,
        destino: document.getElementById('destino').value,
        tipo_cliente: document.getElementById('tipo_cliente').value,
        identificador: document.getElementById('identificador').value,
        nota: document.getElementById('nota').value || null,
        fecha_salida: new Date().toISOString().split('T')[0]
      }]);

    if (error) {
      alert("❌ Error al guardar: " + error.message);
    } else {
      alert("✅ Registro guardado correctamente.");
      form.reset();
      await cargarColaboradores(); // vuelve a cargar por si hubo cambios
    }
  });
</script>


